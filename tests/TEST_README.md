# Carton Number Logic 测试说明

这个目录包含了用于测试分盒/套盒模板Carton Number计算逻辑的测试工具。

## 测试文件

### 1. `quick_test.py` - 快速验证
快速测试你的具体场景和常见情况：

```bash
python quick_test.py
```

**功能：**
- 测试你提到的具体参数组合 (730张/盒, 15盒/套, 8盒/大箱)
- 验证20个大箱和正确的Carton No序列
- 测试三级模式的计算逻辑
- 输出详细的计算过程

### 2. `test_carton_logic.py` - 完整测试套件
运行所有测试用例，全面验证逻辑：

```bash
python test_carton_logic.py
```

**测试覆盖：**
- **二级模式** (无小箱):
  - 一套分多个大箱 (1-1, 1-2, 2-1...)
  - 一套分一个大箱 (1, 2, 3...)
  - 多套分一个大箱 (1-2, 3-4...)
  
- **三级模式** (有小箱):
  - 小箱标的三种Carton No模式
  - 大箱标的三种Carton No模式
  - 各种参数组合

- **边界情况**:
  - 最小值测试
  - 整除情况
  - 有余数情况

## 测试逻辑说明

### 核心计算公式

#### 二级模式 (无小箱)
```
总盒数 = ceil(总张数 ÷ 张/盒)
总套数 = ceil(总盒数 ÷ 盒/套)
每套大箱数 = ceil(盒/套 ÷ 盒/大箱)
总大箱数 = 总套数 × 每套大箱数
```

#### 三级模式 (有小箱)
```
总盒数 = ceil(总张数 ÷ 张/盒)
总套数 = ceil(总盒数 ÷ 盒/套)
每套小箱数 = ceil(盒/套 ÷ 盒/小箱)
每套大箱数 = ceil(每套小箱数 ÷ 小箱/大箱)
总小箱数 = 总套数 × 每套小箱数
总大箱数 = 总套数 × 每套大箱数
```

### Carton No 生成规则

#### 大箱标
- **每套大箱数 > 1**: 多级编号 "套号-大箱号" (1-1, 1-2, 2-1...)
- **每套大箱数 = 1**: 单级编号 "大箱号" (1, 2, 3...)
- **每套大箱数 < 1**: 范围编号 "起始套号-结束套号" (1-3, 4-6...)

#### 小箱标 (仅三级模式)
- **每套小箱数 > 1**: 多级编号 "套号-小箱号" (1-1, 1-2, 2-1...)
- **每套小箱数 = 1**: 单级编号 "小箱号" (01, 02, 03...)
- **每套小箱数 < 1**: 不生成小箱标

## 使用示例

### 验证特定参数
如果你想测试特定的参数组合，修改 `quick_test.py` 中的参数：

```python
params = {
    "张/盒": 你的值,
    "盒/套": 你的值, 
    "盒/小箱": 你的值,  # 二级模式下是盒/大箱
    "小箱/大箱": 你的值,
    "是否有小箱": True/False
}
```

### 添加新测试用例
在 `test_carton_logic.py` 中添加新的测试用例：

```python
self._run_test({
    "name": "你的测试名称",
    "params": {...},
    "data": {"总张数": "数值"},
    "expected": {
        "total_large_boxes": 期望值,
        "carton_no_sample": ["期望的Carton No列表"]
    }
})
```

## 故障排除

### 常见问题

1. **模块导入错误**
   - 确保在项目根目录运行测试
   - 检查 `src/pdf/split_box/` 路径是否正确

2. **计算结果不符合预期**
   - 检查参数映射是否正确 (二级模式下"盒/小箱"实际是"盒/大箱")
   - 验证向上取整 (ceil) 计算
   - 确认基于套数计算而非简单除法

3. **Carton No 格式错误**
   - 检查渲染模式判断逻辑
   - 验证 math.ceil() 在模式判断中的使用

### 调试技巧

如果测试失败，可以：
1. 运行 `quick_test.py` 查看详细计算过程
2. 在 `test_carton_logic.py` 中注释掉输出重定向，查看完整调试信息
3. 手动验证期望值计算是否正确

## 测试结果示例

## 测试结果导出

### 自动导出功能
运行测试后，系统会自动生成详细的测试报告：

#### `test_carton_logic.py` 导出文件：
- **`test_results_YYYYMMDD_HHMMSS.json`** - 完整测试数据（JSON格式）
- **`test_report_YYYYMMDD_HHMMSS.md`** - 详细测试报告（Markdown格式）

#### `quick_test.py` 导出文件：
- **`quick_test_results_YYYYMMDD_HHMMSS.md`** - 快速测试结果报告

### 报告内容

测试报告包含：
- 📊 **测试概览**: 通过率、耗时、测试数量统计
- 📋 **详细结果**: 每个测试用例的参数、计算过程、Carton No序列
- 🔍 **错误分析**: 失败测试的具体错误信息
- 🏁 **测试总结**: 覆盖范围和结论

### 示例报告结构

```markdown
# Carton Number Logic 测试报告

## 📊 测试概览
| 项目 | 值 |
|------|-----|
| 总测试数 | 13 |
| 通过测试 | 13 |
| 失败测试 | 0 |
| 成功率 | 100% |

## 📋 详细测试结果

### 1. ✅ 二级_一套分2个大箱
**测试参数**:
- 张/盒: 730
- 盒/套: 15
- 总张数: 109500

**计算结果**:
- 总盒数: 150
- 总套数: 10
- 总大箱数: 20
- 大箱Carton No前10个: ['1-1', '1-2', '2-1', '2-2', ...]

### 2. ✅ 三级_一套分多个小箱和大箱
...
```

## 分析和查看建议

### 1. 快速验证
使用 `quick_test.py` 快速验证核心逻辑，适合：
- 验证特定参数组合
- 调试具体问题
- 查看详细计算过程

### 2. 全面测试
使用 `test_carton_logic.py` 进行完整验证，适合：
- 验证逻辑修改的影响
- 回归测试
- 质量保证

### 3. 结果分析
- **JSON文件**: 包含完整数据，适合程序化分析
- **Markdown文件**: 格式化报告，适合人工阅读和分享
- 可以将报告导入文档系统或发送给团队

### 4. 趋势追踪
- 保存历史测试报告，对比不同版本的测试结果
- 使用时间戳文件名，追踪逻辑变更的影响

运行 `quick_test.py` 的期望输出：
```
🧪 测试你的具体场景
----------------------------------------
📊 计算过程:
   总张数: 109500
   张/盒: 730
   总盒数: 150 = ceil(109500 ÷ 730)
   盒/套: 15
   总套数: 10 = ceil(150 ÷ 15)
   盒/大箱: 8
   每套大箱数: 2 = ceil(15 ÷ 8)
   总大箱数: 20 = 10 × 2

🎉 测试通过! 逻辑正确!

📄 快速测试结果已导出: quick_test_results_20231218_143022.md
```